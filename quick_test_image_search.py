#!/usr/bin/env python3
"""
Test rapide de la recherche d'images dans Yukpo
Version simplifi√©e pour tests rapides
"""

import requests
import base64
import os
import sys

def quick_test():
    """Test rapide de la recherche d'images"""
    print("üöÄ Test rapide de recherche d'images dans Yukpo")
    print("=" * 50)
    
    # Configuration
    BASE_URL = "http://localhost:3001"
    API_BASE = f"{BASE_URL}/api"
    
    # V√©rifier que l'image de test existe
    test_image_path = "test_image.jpg"
    if not os.path.exists(test_image_path):
        print(f"‚ùå Image de test non trouv√©e: {test_image_path}")
        print("üí° Placez l'image de test dans le r√©pertoire courant")
        return False
    
    # V√©rifier que le backend est accessible
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code != 200:
            print(f"‚ùå Backend non accessible (status: {response.status_code})")
            return False
        print("‚úÖ Backend accessible")
    except Exception as e:
        print(f"‚ùå Backend non accessible: {e}")
        return False
    
    # Demander le token
    token = input("üîë Entrez votre token d'authentification (ou appuyez sur Entr√©e pour tester sans auth): ").strip()
    headers = {}
    if token:
        headers["Authorization"] = f"Bearer {token}"
        print("‚úÖ Token fourni")
    else:
        print("‚ö†Ô∏è Test sans authentification")
    
    # Test 1: V√©rifier l'endpoint de recherche d'images
    print("\nüîç Test 1: V√©rification de l'endpoint de recherche d'images")
    try:
        response = requests.get(f"{API_BASE}/image-search/health", headers=headers, timeout=5)
        if response.status_code == 200:
            print("‚úÖ Endpoint de recherche d'images accessible")
        else:
            print(f"‚ö†Ô∏è Endpoint accessible mais status: {response.status_code}")
    except Exception as e:
        print(f"‚ùå Endpoint non accessible: {e}")
    
    # Test 2: V√©rifier la structure de la base de donn√©es
    print("\nüóÑÔ∏è Test 2: V√©rification de la structure de la base")
    try:
        response = requests.get(f"{API_BASE}/admin/db/structure", headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            media_columns = data.get("media", {}).get("columns", [])
            required_columns = ["image_signature", "image_hash", "image_metadata"]
            
            missing_columns = [col for col in required_columns if col not in media_columns]
            if not missing_columns:
                print("‚úÖ Toutes les colonnes de recherche d'images sont pr√©sentes")
            else:
                print(f"‚ùå Colonnes manquantes: {missing_columns}")
                print("üí° Appliquez la migration: migrations/20250110000000_extend_media_for_image_search.sql")
        else:
            print(f"‚ö†Ô∏è Impossible de v√©rifier la structure (status: {response.status_code})")
    except Exception as e:
        print(f"‚ö†Ô∏è Impossible de v√©rifier la structure: {e}")
    
    # Test 3: Test de recherche simple
    print("\nüîç Test 3: Test de recherche d'images")
    try:
        # Encoder l'image en base64
        with open(test_image_path, "rb") as f:
            image_data = f.read()
        
        # Cr√©er un fichier temporaire pour l'upload
        temp_path = "temp_test.jpg"
        with open(temp_path, "wb") as f:
            f.write(image_data)
        
        # Test d'upload et recherche
        with open(temp_path, "rb") as f:
            files = {"image": f}
            response = requests.post(
                f"{API_BASE}/image-search/upload",
                files=files,
#!/usr/bin/env python3
"""
Test rapide de la recherche d'images dans Yukpo
Version simplifi√©e pour tests rapides
"""

import requests
import base64
import os
import sys

def quick_test():
    """Test rapide de la recherche d'images"""
    print("üöÄ Test rapide de recherche d'images dans Yukpo")
    print("=" * 50)
    
    # Configuration
    BASE_URL = "http://localhost:3001"
    API_BASE = f"{BASE_URL}/api"
    
    # V√©rifier que l'image de test existe
    test_image_path = "test_image.jpg"
    if not os.path.exists(test_image_path):
        print(f"‚ùå Image de test non trouv√©e: {test_image_path}")
        print("üí° Placez l'image de test dans le r√©pertoire courant")
        return False
    
    # V√©rifier que le backend est accessible
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code != 200:
            print(f"‚ùå Backend non accessible (status: {response.status_code})")
            return False
        print("‚úÖ Backend accessible")
    except Exception as e:
        print(f"‚ùå Backend non accessible: {e}")
        return False
    
    # Demander le token
    token = input("üîë Entrez votre token d'authentification (ou appuyez sur Entr√©e pour tester sans auth): ").strip()
    headers = {}
    if token:
        headers["Authorization"] = f"Bearer {token}"
        print("‚úÖ Token fourni")
    else:
        print("‚ö†Ô∏è Test sans authentification")
    
    # Test 1: V√©rifier l'endpoint de recherche d'images
    print("\nüîç Test 1: V√©rification de l'endpoint de recherche d'images")
    try:
        response = requests.get(f"{API_BASE}/image-search/health", headers=headers, timeout=5)
        if response.status_code == 200:
            print("‚úÖ Endpoint de recherche d'images accessible")
        else:
            print(f"‚ö†Ô∏è Endpoint accessible mais status: {response.status_code}")
    except Exception as e:
        print(f"‚ùå Endpoint non accessible: {e}")
    
    # Test 2: V√©rifier la structure de la base de donn√©es
    print("\nüóÑÔ∏è Test 2: V√©rification de la structure de la base")
    try:
        response = requests.get(f"{API_BASE}/admin/db/structure", headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            media_columns = data.get("media", {}).get("columns", [])
            required_columns = ["image_signature", "image_hash", "image_metadata"]
            
            missing_columns = [col for col in required_columns if col not in media_columns]
            if not missing_columns:
                print("‚úÖ Toutes les colonnes de recherche d'images sont pr√©sentes")
            else:
                print(f"‚ùå Colonnes manquantes: {missing_columns}")
                print("üí° Appliquez la migration: migrations/20250110000000_extend_media_for_image_search.sql")
        else:
            print(f"‚ö†Ô∏è Impossible de v√©rifier la structure (status: {response.status_code})")
    except Exception as e:
        print(f"‚ö†Ô∏è Impossible de v√©rifier la structure: {e}")
    
    # Test 3: Test de recherche simple
    print("\nüîç Test 3: Test de recherche d'images")
    try:
        # Encoder l'image en base64
        with open(test_image_path, "rb") as f:
            image_data = f.read()
        
        # Cr√©er un fichier temporaire pour l'upload
        temp_path = "temp_test.jpg"
        with open(temp_path, "wb") as f:
            f.write(image_data)
        
        # Test d'upload et recherche
        with open(temp_path, "rb") as f:
            files = {"image": f}
            response = requests.post(
                f"{API_BASE}/image-search/upload",
                files=files,
                headers=headers,
                timeout=30
            )
        
        # Nettoyer le fichier temporaire
        os.remove(temp_path)
        
        if response.status_code == 200:
            results = response.json()
            total_found = results.get("total_found", 0)
            print(f"‚úÖ Recherche r√©ussie! {total_found} r√©sultats trouv√©s")
            
            if total_found > 0:
                print("üìä Premiers r√©sultats:")
                for i, result in enumerate(results.get("results", [])[:3]):
                    service_id = result.get("service_id", "N/A")
                    score = result.get("similarity_score", 0)
                    print(f"  {i+1}. Service ID: {service_id}, Score: {score:.3f}")
            else:
                print("‚ÑπÔ∏è Aucun r√©sultat trouv√© (normal si la base est vide)")
                
        elif response.status_code == 401:
            print("‚ùå Erreur d'authentification - token requis")
        elif response.status_code == 404:
            print("‚ùå Endpoint de recherche d'images non trouv√©")
        else:
            print(f"‚ùå Erreur lors de la recherche (status: {response.status_code})")
            print(f"R√©ponse: {response.text[:200]}...")
            
    except Exception as e:
        print(f"‚ùå Erreur lors du test de recherche: {e}")
    
    # Test 4: V√©rification des m√©dias existants
    print("\nüì∑ Test 4: V√©rification des m√©dias existants")
    try:
        response = requests.get(f"{API_BASE}/admin/media/count", headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            total_media = data.get("total", 0)
            total_images = data.get("images", 0)
            images_with_signature = data.get("images_with_signature", 0)
            
            print(f"üìä Statistiques des m√©dias:")
            print(f"  - Total: {total_media}")
            print(f"  - Images: {total_images}")
            print(f"  - Images avec signature: {images_with_signature}")
            
            if total_images > 0 and images_with_signature == 0:
                print("‚ö†Ô∏è Images pr√©sentes mais sans signatures - traitement requis")
            elif total_images == 0:
                print("‚ÑπÔ∏è Aucune image dans la base (normal pour une nouvelle installation)")
            else:
                print("‚úÖ Images correctement trait√©es")
        else:
            print(f"‚ö†Ô∏è Impossible de r√©cup√©rer les statistiques (status: {response.status_code})")
    except Exception as e:
        print(f"‚ö†Ô∏è Impossible de r√©cup√©rer les statistiques: {e}")
    
    print("\n" + "=" * 50)
    
    # R√©sum√© et recommandations
    print("üìã R√©sum√© du test rapide:")
    print("‚úÖ Backend accessible")
    
    # Recommandations
    print("\nüîß Recommandations:")
    if not token:
        print("1. Fournissez un token d'authentification pour des tests complets")
    
    print("2. Pour un test complet, utilisez: python test_image_search.py")
    print("3. Pour v√©rifier la base de donn√©es: .\\test_image_search.ps1")
    print("4. Pour appliquer la migration: .\\apply_image_search_migration.ps1")
    
    print("\nüéØ Test rapide termin√©!")
    return True

if __name__ == "__main__":
    try:
        success = quick_test()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\n\n‚ùå Test interrompu par l'utilisateur")
        sys.exit(1)
    except Exception as e:
        print(f"\n\n‚ùå Erreur inattendue: {e}")
        sys.exit(1) 